<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Location Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    input, button { padding: 10px; margin: 5px; width: 80%; max-width: 400px; }
  </style>
</head>
<body>
  <h2>Delivery Driver Location Update</h2>
  <p>Enter your Order ID and allow location access to begin tracking.</p>

  <input type="text" id="orderId" placeholder="Enter Order ID">
  <button onclick="startTracking()">Start Tracking</button>
  <p id="status"></p>

  <script>
    const BACKEND_URL = "https://your-backend-api.com/api/update_location"; // <-- change this later

    let lastPosition = null;
    let orderId;

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function startTracking() {
      orderId = document.getElementById("orderId").value.trim();
      if (!orderId) return alert("Please enter a valid Order ID");

      document.getElementById("status").textContent = "Tracking started. Keep this page open.";

      navigator.geolocation.watchPosition(async pos => {
        const { latitude, longitude } = pos.coords;

        if (!lastPosition || getDistance(lastPosition.lat, lastPosition.lng, latitude, longitude) >= 500) {
          lastPosition = { lat: latitude, lng: longitude };
          document.getElementById("status").textContent = `Updating location... (${latitude.toFixed(5)}, ${longitude.toFixed(5)})`;

          await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: orderId,
              lat: latitude,
              lon: longitude
            })
          });
        }
      }, err => {
        alert("Location access denied. Please enable GPS.");
      }, { enableHighAccuracy: true });
    }
  </script>
</body>
</html>
